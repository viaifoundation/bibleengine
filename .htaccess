<IfModule mod_rewrite.c>
RewriteEngine On
Options -Indexes +FollowSymLinks
IndexIgnore  .htaccess .htpasswd

# Prevent redirect loops - exclude index.php and existing files/directories
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/index\.php [NC]

# Bible.* patterns
RewriteRule ^[Bb]ible\.([a-zA-Z0-9]{1,})\.html$ index.php?n=$1 [L,QSA]
RewriteRule ^[Bb]ible\.([a-zA-Z0-9]{1,})\.([a-zA-Z0-9]{1,})\.html$ index.php?n=$1&c=$2 [L,QSA]
RewriteRule ^[Bb]ible\.([a-zA-Z0-9]{1,})\.([a-zA-Z0-9]{1,})-([a-zA-Z0-9]{1,})\.html$ index.php?n=$1&c=$2&c2=$3 [L,QSA]
RewriteRule ^[Bb]ible\.([a-zA-Z0-9]{1,})\.([a-zA-Z0-9]{1,})\.([a-zA-Z0-9]{1,})\.html$ index.php?n=$1&c=$2&v=$3 [L,QSA]
RewriteRule ^[Bb]ible\.([a-zA-Z0-9]{1,})\.([a-zA-Z0-9]{1,})\.([a-zA-Z0-9]{1,})-([a-zA-Z0-9]{1,})\.html$ index.php?n=$1&c=$2&v=$3&v2=$4 [L,QSA]

# Three-part rules (book.chapter.verse) must come BEFORE two-part rules to match correctly
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/index\.php [NC]
RewriteRule ^([a-zA-Z0-9]{1,})\.([0-9]{1,})\.([0-9]{1,})-([0-9]{1,})\.html$ index.php?q=$1+$2:$3-$4 [L,QSA]
RewriteRule ^([a-zA-Z0-9]{1,})\.([0-9]{1,})\.([0-9]{1,})-([0-9]{1,})\.htm$ index.php?q=$1+$2:$3-$4 [L,QSA]
RewriteRule ^([a-zA-Z0-9]{1,})\.([0-9]{1,})\.([0-9]{1,})\.html$ index.php?q=$1+$2:$3 [L,QSA]
RewriteRule ^([a-zA-Z0-9]{1,})\.([0-9]{1,})\.([0-9]{1,})\.htm$ index.php?q=$1+$2:$3 [L,QSA]

# Two-part rules (book.chapter or book-verse)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/index\.php [NC]
RewriteRule ^([a-zA-Z0-9]{1,})\.([0-9]{1,})-([0-9]{1,})\.html$ index.php?q=$1+$2:$3 [L,QSA]
RewriteRule ^([a-zA-Z0-9]{1,})\.([0-9]{1,})-([0-9]{1,})\.htm$ index.php?q=$1+$2:$3 [L,QSA]
RewriteRule ^([a-zA-Z0-9]{1,})\.([0-9]{1,})\.html$ index.php?q=$1+$2 [L,QSA]
RewriteRule ^([a-zA-Z0-9]{1,})\.([0-9]{1,})\.htm$ index.php?q=$1+$2 [L,QSA]

# Single-part rules (book only)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/index\.php [NC]
RewriteRule ^([a-zA-Z0-9]{1,})\.html$ index.php?q=$1+1 [L,QSA]
RewriteRule ^([a-zA-Z0-9]{1,})\.htm$ index.php?q=$1+1 [L,QSA]

# API endpoints - clean URLs
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/index\.php [NC]
RewriteRule ^api/?$ api/index.php [L,QSA]
RewriteRule ^api/ai/?$ api/ai.php [L,QSA]

# Set HTTP_AUTHORIZATION environment variable (for API authentication)
RewriteCond %{REQUEST_URI} !^/index\.php [NC]
RewriteCond %{REQUEST_URI} (/|\.php|\.html|\.htm|\.feed|\.pdf|\.raw|/[^.]*)$ [NC]
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization},L]
</IfModule>
